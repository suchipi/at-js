#!/usr/bin/env node
const util = require("util");
const clefairy = require("clefairy");
const runExpression = require("../lib/run-expression");
const printHelp = require("../lib/print-help");
const readStdin = require("../lib/read-stdin");

clefairy.run(
  {
    help: clefairy.optionalBoolean,
    h: clefairy.optionalBoolean,
    depth: clefairy.optionalNumber,
    colors: clefairy.optionalBoolean,
    maxArrayLength: clefairy.optionalNumber,
    maxStringLength: clefairy.optionalNumber,
  },
  async (options, ...args) => {
    if (options.help || options.h) {
      printHelp(
        "run some JavaScript and log the result",
        `
          Runs the JavaScript passed as stdin or via a positional argument to @BINARY_NAME@ and logs the result.

          You can pass --colors, --depth, --max-array-length and/or --max-string-length to forward them to util.inspect.
        `,
        `
          echo '2 + 2' | @BINARY_NAME@
          @BINARY_NAME@ '2 + 2'

          @BINARY_NAME@ 'process' --depth 0
          @BINARY_NAME@ 'process' --depth Infinity --colors false
        `
      );
    }

    const jsString = (await readStdin()) || args.join(" ");

    const inspect = (value) =>
      util.inspect(value, {
        colors: options.colors === undefined ? true : options.colors,
        depth: options.depth === undefined ? 2 : options.depth,
        maxStringLength:
          options.maxStringLength === undefined
            ? 10000
            : options.maxStringLength,
        maxArrayLength:
          options.maxArrayLength === undefined ? 100 : options.maxArrayLength,
        showHidden: true,
        showProxy: true,
      });

    let result = runExpression(jsString);
    if (typeof result === "function") {
      const highlight = require("@babel/highlight").default;

      result = inspect(result) + "\n" + highlight(result.toString());
    }

    if (typeof result !== "string") {
      console.log(inspect(result));
    } else {
      console.log(result);
    }
  }
);

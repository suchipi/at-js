#!/usr/bin/env node
const clefairy = require("clefairy");
const readStdin = require("../lib/read-stdin");
const runExpression = require("../lib/run-expression");
const printHelp = require("../lib/print-help");
const parseJson = require("../lib/parse-json");

clefairy.run(
  { help: clefairy.optionalBoolean, h: clefairy.optionalBoolean },
  async (options, ...args) => {
    if (options.help || options.h) {
      printHelp(
        "evaluate a function once per item in input JSON array",
        `
          Reads stdin as a JSON array, then calls its .forEach method, passing in the
          function you pass as the first argument to @BINARY_NAME@ (as a string).
        `,
        `
          echo '[1, [2], [[3, 4], 5]]' | @BINARY_NAME@ 'item => console.log(typeof item)'

          # You can use \`exec\` to run a command in a subshell and return its output:
          echo '["blah.txt", "README.md"]' | @BINARY_NAME@ 'item => exec(\`cp ./a/\${item} ./b/\${item}\`)'
        `
      );
    }

    const stdinStr = await readStdin();

    const items = parseJson.array(stdinStr);

    const forEachFunction = runExpression(args[0]);
    items.forEach(forEachFunction);
  }
);
